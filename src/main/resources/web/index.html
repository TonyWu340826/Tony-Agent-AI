<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TonyWu AI 平台 - 认证与后台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 图标库：lucide-react UMD，全局变量为 LucideReact -->
    <script src="https://unpkg.com/lucide-react/umd/lucide-react.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <style>
        /* 显式设置中文字体堆栈，以解决乱码问题 */
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Heiti SC', sans-serif;
        }
        /* 隐藏滚动条但允许滚动 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>
<div id="root"></div>

    <script type="text/javascript" defer src="/js/article-management.js"></script>
    <script type="text/javascript" defer src="/js/member-management.js"></script>
    <script type="text/javascript" defer src="/js/comment-management.js"></script>
    <script type="text/javascript" defer src="/js/like-management.js"></script>
    <script type="text/javascript" defer src="/js/recharge-management.js"></script>
    <script type="text/javascript" defer src="/js/category-management.js"></script>
    <script type="text/javascript" defer src="/js/interview-management.js"></script>
    <script type="text/javascript" defer src="/js/system-management.js"></script>
    <script type="text/javascript" defer src="/js/ai-tool-management.js"></script>
    <script type="text/javascript" defer src="/tools/10-aiSql-tools-management.js"></script>
    <script type="text/javascript" defer src="/js/dashboard-summary.js"></script>
<script type="text/babel">
    class ErrorBoundary extends React.Component {
        constructor(props) { super(props); this.state = { hasError: false, error: null }; }
        static getDerivedStateFromError(error) { return { hasError: true, error }; }
        componentDidCatch(error, info) { /* 可上报 */ }
        handleReset = () => this.setState({ hasError: false, error: null });
        render() {
            if (this.state.hasError) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 text-red-700 border border-red-200 p-3 rounded-lg text-sm shadow-md mb-3">
                            组件渲染失败：{String(this.state.error)}
                        </div>
                        <button className="px-4 py-2 rounded-md bg-blue-600 text-white" onClick={this.handleReset}>重试</button>
                    </div>
                );
            }
            return this.props.children;
        }
    }
    // --- 修复图标引用错误并添加安全降级 ---
    const FallbackIcon = ({ className = 'w-5 h-5', style = {} }) => (
        <div className={className} style={{ ...style, backgroundColor: '#ccc', borderRadius: '4px', opacity: 0.5 }}></div>
    );
    const Svg = ({ children, className }) => (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{children}</svg>
    );
    const LogIn = ({ className }) => <Svg className={className}><path d="M15 3h6v18h-6"/><path d="M10 17l5-5-5-5"/><path d="M15 12H3"/></Svg>;
    const UserPlus = ({ className }) => <Svg className={className}><circle cx="9" cy="7" r="4"/><path d="M17 21a8 8 0 10-16 0"/><path d="M19 8v6"/><path d="M22 11h-6"/></Svg>;
    const Home = ({ className }) => <Svg className={className}><path d="M3 12l9-9 9 9"/><path d="M9 21V12h6v9"/></Svg>;
    const Menu = ({ className }) => <Svg className={className}><path d="M3 6h18"/><path d="M3 12h18"/><path d="M3 18h18"/></Svg>;
    const X = ({ className }) => <Svg className={className}><path d="M18 6L6 18"/><path d="M6 6l12 12"/></Svg>;
    const CheckCircle = ({ className }) => <Svg className={className}><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></Svg>;
    const AlertCircle = ({ className }) => <Svg className={className}><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></Svg>;
    const TrendingUp = ({ className }) => <Svg className={className}><path d="M3 17l6-6 4 4 8-8"/><path d="M14 7h7v7"/></Svg>;
    const Cpu = ({ className }) => <Svg className={className}><rect x="6" y="6" width="12" height="12" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 2v4"/><path d="M15 2v4"/><path d="M9 18v4"/><path d="M15 18v4"/><path d="M2 9h4"/><path d="M2 15h4"/><path d="M18 9h4"/><path d="M18 15h4"/></Svg>;
    const Gift = ({ className }) => <Svg className={className}><rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M2 8h20"/><path d="M12 8c-2 0-5-1-5-3s3-3 5 0c2-3 5-1 5 1s-3 2-5 2"/></Svg>;
    const Sun = ({ className }) => <Svg className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></Svg>;
    const Users = ({ className }) => <Svg className={className}><circle cx="9" cy="7" r="4"/><circle cx="17" cy="11" r="3"/><path d="M3 21a8 8 0 0112 0"/><path d="M10 21a8 8 0 018-5"/></Svg>;
    const FileText = ({ className }) => <Svg className={className}><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h5"/></Svg>;
    const LayoutDashboard = ({ className }) => <Svg className={className}><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/></Svg>;
    const Plus = ({ className }) => <Svg className={className}><path d="M12 5v14"/><path d="M5 12h14"/></Svg>;
    const Search = ({ className }) => <Svg className={className}><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></Svg>;
    const MessageSquare = ({ className }) => <Svg className={className}><path d="M21 15a2 2 0 01-2 2H8l-5 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></Svg>;
    const Heart = ({ className }) => <Svg className={className}><path d="M20.8 4.6a5.5 5.5 0 00-7.8 0L12 5.6l-1-1a5.5 5.5 0 00-7.8 7.8L12 21l8.8-8.6a5.5 5.5 0 000-7.8z"/></Svg>;
    const Layers = ({ className }) => <Svg className={className}><path d="M12 2l9 5-9 5-9-5 9-5z"/><path d="M3 12l9 5 9-5"/><path d="M3 17l9 5 9-5"/></Svg>;
    const BookOpen = ({ className }) => <Svg className={className}><path d="M2 5h8a3 3 0 013 3v11H5a3 3 0 01-3-3V5z"/><path d="M22 5h-8a3 3 0 00-3 3v11h8a3 3 0 003-3V5z"/></Svg>;
    const Settings = ({ className }) => <Svg className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.6 15 1.65 1.65 0 004 14H3a2 2 0 010-4h1a1.65 1.65 0 00.6-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 007.6 4.6 1.65 1.65 0 009 4V3a2 2 0 014 0v1a1.65 1.65 0 001-.6 1.65 1.65 0 001.82.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9c.2.31.35.65.41 1H21a2 2 0 010 4h-1a1.65 1.65 0 00-.6 1z"/></Svg>;
    const ChevronRight = ({ className }) => <Svg className={className}><path d="M9 18l6-6-6-6"/></Svg>;

    // --- 配置 ---
    const API_URL = "/api/auth";
    const { useState, useEffect } = React;

    /**
     * 状态消息组件
     */
    const MessageBox = ({ message, type }) => {
        if (!message) return null;
        const baseClasses = "p-3 rounded-lg text-sm flex items-center shadow-md";
        let typeClasses = "";
        let Icon = CheckCircle;
        if (type === 'error') {
            typeClasses = "bg-red-100 text-red-700 border border-red-200";
            Icon = AlertCircle;
        } else {
            typeClasses = "bg-green-100 text-green-700 border border-green-200";
            Icon = CheckCircle;
        }
        return (
            <div className={`${baseClasses} ${typeClasses}`} role="alert">
                <Icon className="w-5 h-5 mr-2 flex-shrink-0" />
                <span>{message}</span>
            </div>
        );
    };

    const InterviewManagementInline = () => {
        const [items, setItems] = useState([]);
        const [page, setPage] = useState(0);
        const [size, setSize] = useState(10);
        const [totalPages, setTotalPages] = useState(0);
        const [searchTerm, setSearchTerm] = useState("");
        const [categoryId, setCategoryId] = useState('');
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [showAdd, setShowAdd] = useState(false);
        const [showEdit, setShowEdit] = useState(false);
        const [editItem, setEditItem] = useState(null);
        const [tree, setTree] = useState([]);
        const [addForm, setAddForm] = useState({ categoryId:'', visibilityVip:0, title:'', question:'', solution:'' });

        const fetchTree = async () => {
            try { const r = await fetch('/api/categories/tree', { credentials:'same-origin' }); const t = await r.text(); const d = JSON.parse(t||'[]'); setTree(d||[]); } catch(_) {}
        };

        const fetchList = async (targetPage = page) => {
            setLoading(true); setError('');
            try {
                const params = new URLSearchParams(); params.set('page', targetPage); params.set('size', size);
                if (searchTerm) params.set('search', searchTerm);
                if (categoryId) params.set('categoryId', categoryId);
                const resp = await fetch(`/api/interview/admin/items?${params.toString()}`, { credentials:'same-origin' });
                const text = await resp.text(); let data = {}; try { data = JSON.parse(text); } catch(_) { throw new Error('接口异常'); }
                if (!resp.ok) throw new Error(data.message || '加载失败');
                setItems(data.content || []); setTotalPages(data.totalPages || 0); setPage(data.number ?? targetPage);
            } catch(e) { setError(e.message || '请求失败'); } finally { setLoading(false); }
        };

        useEffect(() => { fetchTree(); fetchList(0); }, []);

        const handleSearch = () => fetchList(0);
        const handlePrev = () => { if (page>0) fetchList(page-1); };
        const handleNext = () => { if (page<totalPages-1) fetchList(page+1); };

        const parentOptions = () => {
            const opts = [];
            const walk = (nodes, prefix='') => { (nodes||[]).forEach(n => { opts.push({ id:n.id, name: prefix ? `${prefix} > ${n.name}` : n.name }); if (n.children && n.children.length) walk(n.children, prefix?`${prefix} > ${n.name}`:n.name); }); };
            walk(tree); return opts;
        };

        const openAdd = () => { setAddForm({ categoryId:'', visibilityVip:0, title:'', question:'', solution:'' }); setShowAdd(true); };
        const openEdit = (it) => { setEditItem({ ...it, solution:'' }); setShowEdit(true); };

        const handleAddSave = async () => {
            if (!addForm.categoryId) { setError('请选择分类'); return; }
            if (!addForm.title.trim()) { setError('请输入标题'); return; }
            if (!addForm.question.trim()) { setError('请输入问题'); return; }
            setLoading(true); setError('');
            try {
                const payload = { categoryId: Number(addForm.categoryId), title: addForm.title.trim(), question: addForm.question.trim(), solution: addForm.solution || '', visibilityVip: Number(addForm.visibilityVip) };
                const resp = await fetch('/api/interview/admin/items', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify(payload) });
                const text = await resp.text(); let data = {}; try { data = JSON.parse(text || '{}'); } catch(_) {}
                if (!resp.ok || data.success===false) throw new Error(data.message || '新增失败');
                setShowAdd(false); setAddForm({ categoryId:'', visibilityVip:0, title:'', question:'', solution:'' }); fetchList(0);
            } catch(e) { setError(e.message || '请求失败'); } finally { setLoading(false); }
        };

        const handleEditSave = async () => {
            if (!editItem) return; setLoading(true); setError('');
            try {
                const payload = { categoryId: Number(editItem.categoryId), title: editItem.title, question: editItem.question, solution: editItem.solution || '', visibilityVip: Number(editItem.visibilityVip) };
                const resp = await fetch(`/api/interview/admin/items/${editItem.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify(payload) });
                const text = await resp.text(); let data = {}; try { data = JSON.parse(text || '{}'); } catch(_) {}
                if (!resp.ok || data.success===false) throw new Error(data.message || '更新失败');
                setShowEdit(false); setEditItem(null); fetchList(page);
            } catch(e) { setError(e.message || '请求失败'); } finally { setLoading(false); }
        };

        const handleDelete = async (id) => {
            if (!confirm('确认删除该条目？')) return; setLoading(true); setError('');
            try {
                const resp = await fetch(`/api/interview/admin/items/${id}`, { method:'DELETE', credentials:'same-origin' });
                const text = await resp.text(); let data = {}; try { data = JSON.parse(text || '{}'); } catch(_) {}
                if (!resp.ok || data.success===false) throw new Error(data.message || '删除失败');
                fetchList(page);
            } catch(e) { setError(e.message || '请求失败'); } finally { setLoading(false); }
        };

        return (
            <div className="p-6 md:p-10 bg白 rounded-xl shadow-lg w-full h-full space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 flex items-center border-b pb-4 mb-4">面试宝典</h2>
                <div className="flex items-center gap-3">
                    <select className="border border-gray-300 rounded-lg px-3 py-2 w-48" value={categoryId} onChange={(e)=>setCategoryId(e.target.value)}>
                        <option value="">全部分类</option>
                        {parentOptions().map(o => (<option key={o.id} value={o.id}>{o.name}</option>))}
                    </select>
                    <input className="border border-gray-300 rounded-lg px-3 py-2 w-full md:w-80" placeholder="搜索标题/问题..." value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') handleSearch(); }} />
                    <button className="px-4 py-2 rounded-md bg-blue-600 text白 hover:bg-blue-700" onClick={handleSearch}>搜索</button>
                    <button className="px-4 py-2 rounded-md bg-green-600 text白 hover:bg-green-700" onClick={openAdd}>新增</button>
                </div>
                {error && (<div className="bg-red-100 text-red-700 border border-red-200 p-3 rounded-lg text-sm shadow-md">{error}</div>)}
                <div className="overflow-x-auto bg白 rounded-lg border border-gray-200 shadow">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50"><tr>
                            {['ID','标题','分类','可见','时间','操作'].map((h,i)=>(<th key={i} className="px-4 py-3 text-left text-xs font-medium text-gray-500">{h}</th>))}
                        </tr></thead>
                        <tbody className="bg白 divide-y divide-gray-200">
                            {loading ? (<tr><td className="px-4 py-6 text-center text-gray-500" colSpan={6}>加载中...</td></tr>) : items.length===0 ? (<tr><td className="px-4 py-6 text-center text-gray-500" colSpan={6}>暂无数据</td></tr>) : items.map(it => (
                                <tr key={it.id}>
                                    <td className="px-4 py-3 text-sm text-gray-700">{it.id}</td>
                                    <td className="px-4 py-3 text-sm text-gray-700">{it.title}</td>
                                    <td className="px-4 py-3 text-sm text-gray-700">{it.categoryName || it.categoryId}</td>
                                    <td className="px-4 py-3 text-sm text-gray-700">{it.visibilityVip===99 ? 'VIP99专享' : 'VIP0可见'}</td>
                                    <td className="px-4 py-3 text-sm text-gray-700">{it.createdAt ? new Date(it.createdAt).toLocaleString() : '-'}</td>
                                    <td className="px-4 py-3 text-sm">
                                        <div className="flex items-center justify-end gap-2 whitespace-nowrap">
                                            <button className="px-3 py-1 rounded-md bg-blue-600 text白 hover:bg-blue-700" onClick={()=>openEdit(it)}>编辑</button>
                                            <button className="px-3 py-1 rounded-md bg-red-600 text白 hover:bg-red-700" onClick={()=>handleDelete(it.id)}>删除</button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600">第 {page + 1} / {Math.max(totalPages, 1)} 页</div>
                    <div className="space-x-2">
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page===0} onClick={handlePrev}>上一页</button>
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page>=totalPages-1} onClick={handleNext}>下一页</button>
                    </div>
                </div>

                {showAdd && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg白 rounded-xl shadow-2xl w-full max-w-2xl p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">新增条目</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={addForm.categoryId} onChange={(e)=>setAddForm({...addForm,categoryId:e.target.value})}>
                                    <option value="">选择分类</option>
                                    {parentOptions().map(o => (<option key={o.id} value={o.id}>{o.name}</option>))}
                                </select>
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={addForm.visibilityVip} onChange={(e)=>setAddForm({...addForm,visibilityVip:e.target.value})}>
                                    <option value={0}>VIP0可见</option>
                                    <option value={99}>VIP99专享</option>
                                </select>
                                <input className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="标题" value={addForm.title} onChange={(e)=>setAddForm({...addForm,title:e.target.value})} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" rows={4} placeholder="问题" value={addForm.question} onChange={(e)=>setAddForm({...addForm,question:e.target.value})} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" rows={6} placeholder="解答(支持HTML)" value={addForm.solution} onChange={(e)=>setAddForm({...addForm,solution:e.target.value})} />
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={()=>{ setShowAdd(false); setAddForm({ categoryId:'', visibilityVip:0, title:'', question:'', solution:'' }); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text白 hover:bg-blue-700" onClick={handleAddSave}>新增</button>
                            </div>
                        </div>
                    </div>
                )}

                {showEdit && editItem && (
                    <div className="fixed inset-0 bg黑/30 flex items-center justify中心 p-4">
                        <div className="bg白 rounded-xl shadow-2xl w-full max-w-2xl p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">编辑条目</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={editItem.categoryId} onChange={(e)=>setEditItem({...editItem,categoryId:e.target.value})}>
                                    {parentOptions().map(o => (<option key={o.id} value={o.id}>{o.name}</option>))}
                                </select>
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={editItem.visibilityVip} onChange={(e)=>setEditItem({...editItem,visibilityVip:e.target.value})}>
                                    <option value={0}>VIP0可见</option>
                                    <option value={99}>VIP99专享</option>
                                </select>
                                <input className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="标题" value={editItem.title ?? ''} onChange={(e)=>setEditItem({...editItem,title:e.target.value})} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" rows={4} placeholder="问题" value={editItem.question ?? ''} onChange={(e)=>setEditItem({...editItem,question:e.target.value})} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" rows={6} placeholder="解答(支持HTML)" value={editItem.solution ?? ''} onChange={(e)=>setEditItem({...editItem,solution:e.target.value})} />
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={()=>{ setShowEdit(false); setEditItem(null); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text白 hover:bg-blue-700" onClick={handleEditSave}>保存</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    /**
     * 认证表单组件 (登录 & 注册)
     */
        const AuthForm = ({ setView, setIsLoggedIn, setUserId }) => {
        const [mode, setMode] = useState('login'); // 'login' or 'register'
        const [username, setUsername] = useState('');
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [nickname, setNickname] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [message, setMessage] = useState('');
        const [messageType, setMessageType] = useState('success');
        const [captcha, setCaptcha] = useState('');
        const captchaUrl = () => `/api/captcha/image?t=${Date.now()}`;
        const [capSrc, setCapSrc] = useState(captchaUrl());

        const isRegister = mode === 'register';

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            setMessage('');

            if (isRegister && password !== confirmPassword) {
                setMessage('两次输入的密码不一致！');
                setMessageType('error');
                return;
            }

            setIsLoading(true);
            const endpoint = isRegister ? `${API_URL}/register` : `${API_URL}/login`;

            let payload;
            if (isRegister) {
                payload = { username, email, password, nickname: nickname || null };
            } else {
                payload = { username, password };
            }

            let requestConfig = {
                method: 'POST',
                headers: {},
                body: null,
            };

            if (isRegister) {
                requestConfig.headers['Content-Type'] = 'application/json';
                requestConfig.body = JSON.stringify({ ...payload, captcha });
            } else {
                const formData = new FormData();
                for (const key in payload) {
                    if (payload[key] !== null && payload[key] !== undefined && payload[key] !== '') {
                        formData.append(key, payload[key]);
                    }
                }
                formData.append('captcha', captcha || '');
                requestConfig.body = formData;
            }

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(endpoint, requestConfig);

                    const responseText = await response.text();
                    let data = { success: response.ok, message: response.ok ? '操作成功！' : '请求失败。' };
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        data.success = response.ok;
                        data.message = response.ok ? '操作成功，但响应非JSON格式。' : `请求失败，状态码: ${response.status}`;
                    }

                    if (data.success) {
                        if (isRegister) {
                            setMessage('注册成功！正在自动跳转到登录...');
                            setMessageType('success');
                            setTimeout(() => {
                                setMode('login');
                                setMessage('');
                                setPassword('');
                                setConfirmPassword('');
                                setEmail('');
                                setNickname('');
                            }, 1500);
                        } else {
                            setMessage('登录成功！正在跳转到管理面板...');
                            setMessageType('success');
                            // 模拟存储认证信息
                            sessionStorage.setItem('authToken', 'simulated-admin-token-' + username);
                            setUserId(username);
                            setIsLoggedIn(true);
                            setTimeout(() => setView('dashboard'), 1000);
                        }
                    } else {
                        setMessage(data.message || (isRegister ? '注册失败，请检查数据。' : '登录失败，请检查账号密码。'));
                        setMessageType('error');
                    }
                    break;

                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    } else {
                        console.error('Fetch error:', error);
                        setMessage(`网络连接失败或服务器无响应。`);
                        setMessageType('error');
                    }
                }
            }
            setIsLoading(false);
        };

        const toggleMode = () => {
            setMode(isRegister ? 'login' : 'register');
            setMessage('');
            setUsername('');
            setEmail('');
            setPassword('');
            setConfirmPassword('');
            setNickname('');
        };

        return (
            <div className="w-full max-w-2xl mx-auto bg白 p-8 md:p-10 space-y-6 rounded-2xl shadow-2xl border border-gray-100/50">
                <h2 className="text-3xl md:text-4xl font-extrabold text-gray-900 text-center">
                    {isRegister ? '新用户注册' : '管理员登录'}
                </h2>

                <MessageBox message={message} type={messageType} />

                <form onSubmit={handleFormSubmit} className="space-y-6">

                    {/* 账号输入 */}
                    <div>
                        <label htmlFor="username" className="block text-sm font-medium text-gray-700">账号</label>
                        <input id="username" type="text" value={username} onChange={e => setUsername(e.target.value)} required
                               className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition"
                               placeholder="请输入用户名" disabled={isLoading} />
                    </div>

                    {/* 邮箱输入 (仅注册模式显示) */}
                    {isRegister && (
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">邮箱</label>
                            <input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required
                                   className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition"
                                   placeholder="请输入电子邮箱" disabled={isLoading} />
                        </div>
                    )}

                    {/* 密码输入 */}
                    <div>
                        <label htmlFor="password" className="block text-sm font-medium text-gray-700">密码</label>
                        <input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required
                               className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition"
                               placeholder="请输入密码" disabled={isLoading} />
                    </div>

                    {/* 确认密码输入 (仅注册模式显示) */}
                    {isRegister && (
                        <div>
                            <label htmlFor="confirm-password" className="block text-sm font-medium text-gray-700">确认密码</label>
                            <input id="confirm-password" type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} required
                                   className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition"
                                   placeholder="请再次输入密码" disabled={isLoading} />
                        </div>
                    )}

                    {/* 昵称输入 (仅注册模式显示) */}
                    {isRegister && (
                        <div>
                            <label htmlFor="nickname" className="block text-sm font-medium text-gray-700">昵称 (可选)</label>
                            <input id="nickname" type="text" value={nickname} onChange={e => setNickname(e.target.value)}
                                   className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition"
                                   placeholder="请输入昵称" disabled={isLoading} />
                        </div>
                    )}

                    {/* 验证码 */}
                    <div className="grid grid-cols-3 gap-3">
                        <div className="col-span-2">
                            <label className="block text-sm font-medium text-gray-700">验证码</label>
                            <input className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-600 focus:border-blue-600 transition" placeholder="请输入验证码" value={captcha} onChange={e=>setCaptcha(e.target.value)} disabled={isLoading} />
                        </div>
                        <div className="flex items-end">
                            <img src={capSrc} alt="验证码" className="h-10 rounded border cursor-pointer" onClick={()=>setCapSrc(captchaUrl())} />
                        </div>
                    </div>

                    {/* 提交按钮 */}
                    <button type="submit" disabled={isLoading}
                            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 transition duration-150 ease-in-out">
                        {isLoading ?
                            (isRegister ? '注册中...' : '登录中...') :
                            (isRegister ? <><UserPlus className="w-5 h-5 mr-2" />注册账号</> : <><LogIn className="w-5 h-5 mr-2" />登录</>)
                        }
                    </button>
                </form>

                <div className="text-center">
                    <button onClick={toggleMode} className="font-medium text-blue-600 hover:text-blue-800 text-sm">
                        {isRegister ? '已有账号？去登录' : '还没有账号？去注册'}
                    </button>
                </div>
            </div>
        );
        };

    /**
     * 导航栏组件 (不变)
     */
    const Header = ({ setView, isLoggedIn, userId, handleLogout }) => {
        const [isMenuOpen, setIsMenuOpen] = useState(false);
        const TimeWeather = () => {
            const [now, setNow] = useState(new Date());
            const [weather, setWeather] = useState('');
            useEffect(()=>{ const t=setInterval(()=>setNow(new Date()), 1000); return ()=>clearInterval(t); },[]);
            useEffect(()=>{
                const load = async () => {
                    let lat=39.9042, lon=116.4074; // 北京默认
                    try {
                        await new Promise((resolve,reject)=>{
                            if(!navigator.geolocation) { resolve(); return; }
                            navigator.geolocation.getCurrentPosition(p=>{ lat=p.coords.latitude; lon=p.coords.longitude; resolve(); }, ()=>resolve(), {timeout:1500});
                        });
                    } catch(_){}
                    try {
                        const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const d = await resp.json();
                        if (d && d.current_weather) {
                            const temp = d.current_weather.temperature;
                            const ws = d.current_weather.windspeed;
                            setWeather(`${temp}℃ 风${ws}`);
                        }
                    } catch(_){ setWeather(''); }
                };
                load();
            },[]);
            return (
                <div className="hidden md:flex items-center text-sm text-gray-600 gap-2">
                    <Sun className="w-5 h-5" />
                    <span>{now.toLocaleString()}</span>
                    {weather && <span className="ml-2">{weather}</span>}
                </div>
            );
        };

        const navItems = [
            { name: '用户主页', view: 'home', icon: Home },
            { name: '技术文章', view: 'articles', icon: TrendingUp },
            { name: 'AI 工具', view: 'tools', icon: Cpu },
            { name: 'VIP 服务', view: 'vip', icon: Gift },
        ];

        // 如果已登录，在导航栏中显示“管理后台”按钮
        if (isLoggedIn) {
            navItems.unshift({ name: '管理后台', view: 'dashboard', icon: LayoutDashboard });
        }


        return (
            <header className="bg-white shadow-md sticky top-0 z-20">
                <div className="w-full px-6 lg:px-10">
                    <div className="flex justify-between items-center h-16">
                        {/* 平台 Logo/名称 */}
                        <div className="flex-shrink-0 cursor-pointer" onClick={() => setView(isLoggedIn ? 'dashboard' : 'auth')}>
                            <span className="text-2xl font-bold text-blue-600">TonyWu AI 平台</span>
                        </div>

                        {/* 桌面端导航菜单 */}
                        <nav className="hidden md:flex space-x-2 lg:space-x-6 text-base">
                            {navItems.map(item => (
                                <button
                                    key={item.name}
                                    onClick={() => {
                                        if (item.id === 'home') { window.location.href = '/home.html'; return; }
                                        setView(isLoggedIn ? item.view : 'auth')
                                    }}
                                    className="text-gray-700 hover:text-blue-600 px-4 py-2 rounded-md font-semibold flex items-center transition duration-150"
                                >
                                    <item.icon className="w-5 h-5 mr-2" />
                                    {item.name}
                                </button>
                            ))}
                        </nav>

                        {/* 登录/用户区域 */}
                        <div className="flex items-center space-x-4">
                            {isLoggedIn ? (
                                <div className="flex items-center space-x-4">
                                        <TimeWeather />
                                        <span className="hidden sm:inline text-sm font-medium text-gray-700">
                                            欢迎, {userId}
                                        </span>
                                    <button
                                        onClick={handleLogout}
                                        className="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-full transition"
                                    >
                                        退出
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setView('auth')}
                                    className="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-full shadow-md transition"
                                >
                                    <LogIn className="w-4 h-4 inline mr-1" /> 登录 / 注册
                                </button>
                            )}
                            {/* 移动端菜单按钮 */}
                            <button className="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-700" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                                {isMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                            </button>
                        </div>
                    </div>
                </div>

                {/* 移动端菜单 */}
                {isMenuOpen && (
                    <div className="md:hidden bg-white border-t border-gray-100 shadow-lg">
                        {navItems.map(item => (
                            <button
                                key={item.name}
                                onClick={() => { if (item.id === 'home') { window.location.href='/home.html'; } else { setView(isLoggedIn ? item.view : 'auth'); } setIsMenuOpen(false); }}
                                className="block w-full text-left px-4 py-2 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition duration-150 flex items-center"
                            >
                                <item.icon className="w-5 h-5 mr-3" />
                                {item.name}
                            </button>
                        ))}
                    </div>
                )}
            </header>
        );
    };

    /**
     * 占位页面组件 (不变)
     */
    const PlaceholderPage = ({ title, description }) => (
        <div className="flex flex-col items-center justify-center w-full min-h-[calc(100vh-8rem)] p-8 text-center bg-white m-4 rounded-xl shadow-lg border border-gray-200">
            <h1 className="text-4xl font-extrabold text-gray-900 mb-4">{title}</h1>
            <p className="text-lg text-gray-600 max-w-xl">{description}</p>
            <p className="mt-8 text-blue-500 font-semibold">此页面为占位符，未来将在此处扩展您的功能。</p>
        </div>
    );

    // --- 新增管理功能组件 ---

    /**
     * 1. 文章管理组件
     */
    const ArticleManagementInline = () => {
        const [articles, setArticles] = useState([]);
        const [page, setPage] = useState(0);
        const [size, setSize] = useState(10);
        const [totalPages, setTotalPages] = useState(0);
        const [searchTerm, setSearchTerm] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [showAdd, setShowAdd] = useState(false);
        const [showEdit, setShowEdit] = useState(false);
        const [showDetail, setShowDetail] = useState(false);
        const [currentArticle, setCurrentArticle] = useState(null);
        const [addForm, setAddForm] = useState({ title: "", slug: "", summary: "", content: "", status: "DRAFT", authorName: "" });

        const fetchArticles = async (targetPage = page) => {
            setLoading(true);
            setError("");
            try {
                const url = `/api/articles/admin?page=${targetPage}&size=${size}${searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : ""}`;
                const response = await fetch(url, { credentials: 'same-origin' });
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) { throw new Error('未登录或接口异常'); }
                if (!response.ok) {
                    throw new Error(data.message || "加载文章失败");
                }
                setArticles(data.content || []);
                setTotalPages(data.totalPages || 0);
                setPage(data.number ?? targetPage);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        useEffect(() => { fetchArticles(0); }, []);

        const handleSearch = () => fetchArticles(0);
        const handlePrev = () => { if (page > 0) fetchArticles(page - 1); };
        const handleNext = () => { if (page < totalPages - 1) fetchArticles(page + 1); };

        const openAdd = () => { setShowAdd(true); };
        const openEdit = (article) => { setCurrentArticle({ ...article }); setShowEdit(true); };
        const openDetail = async (id) => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/articles/admin/${id}`, { credentials: 'same-origin' });
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text || '{}'); } catch (_) { throw new Error('加载详情失败'); }
                if (!response.ok) throw new Error(data.message || '加载详情失败');
                setCurrentArticle(data);
                setShowDetail(true);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const handleAddSave = async () => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch('/api/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(addForm)
                });
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text || '{}'); } catch (_) { throw new Error('新增失败'); }
                if (!response.ok) throw new Error(data.message || '新增失败');
                setShowAdd(false);
                setAddForm({ title: "", slug: "", summary: "", content: "", status: "DRAFT", authorName: "" });
                fetchArticles(0);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const handleEditSave = async () => {
            if (!currentArticle) return;
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/articles/${currentArticle.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        title: currentArticle.title,
                        slug: currentArticle.slug,
                        summary: currentArticle.summary,
                        content: currentArticle.content,
                        status: currentArticle.status || 'DRAFT',
                        contentFormat: currentArticle.contentFormat || 'PLAINTEXT',
                        type: currentArticle.type || null
                    })
                });
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text || '{}'); } catch (_) { throw new Error('更新失败'); }
                if (!response.ok) throw new Error(data.message || '更新失败');
                setShowEdit(false);
                setCurrentArticle(null);
                fetchArticles(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const handlePublish = async (id) => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/articles/${id}/publish`, { method: 'PUT' });
                if (!response.ok) {
                    const text = await response.text();
                    try { const data = JSON.parse(text || '{}'); throw new Error(data.message || '发布失败'); } catch(_) { throw new Error('发布失败'); }
                }
                fetchArticles(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally { setLoading(false); }
        };

        const handleUnpublish = async (id) => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/articles/${id}/unpublish`, { method: 'PUT' });
                if (!response.ok) {
                    const text = await response.text();
                    try { const data = JSON.parse(text || '{}'); throw new Error(data.message || '下架失败'); } catch(_) { throw new Error('下架失败'); }
                }
                fetchArticles(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally { setLoading(false); }
        };

        const handleDelete = async (id) => {
            if (!confirm('确认删除该文章？')) return;
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/articles/${id}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 200) {
                    const text = await response.text();
                    try { const data = JSON.parse(text || '{}'); throw new Error(data.message || '删除失败'); } catch(_) { throw new Error('删除失败'); }
                }
                fetchArticles(page);
            } catch (e) { setError(e.message || "请求失败"); } finally { setLoading(false); }
        };

        return (
            <div className="p-6 md:p-10 bg-white rounded-xl shadow-lg w-full h-full space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 flex items-center border-b pb-4 mb-4">
                    <FileText className="w-7 h-7 mr-3 text-blue-600" /> 文章内容管理
                </h2>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button className="flex items-center bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150" onClick={openAdd}>
                        <Plus className="w-5 h-5 mr-2" /> 新建文章
                    </button>
                    <div className="relative w-full sm:w-1/3">
                        <input type="search" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleSearch(); }} placeholder="搜索标题/摘要/slug..." className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                        <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    </div>
                    <button className="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md" onClick={handleSearch}>搜索</button>
                </div>

                {error && (<div className="bg-red-100 text-red-700 border border-red-200 p-3 rounded-lg text-sm shadow-md">{error}</div>)}

                <div className="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">ID</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">标题</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">Slug</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">摘要</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">作者</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">状态</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">类型</th>
                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">操作</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {loading ? (
                                <tr><td className="px-4 py-6 text-center text-gray-500" colSpan="7">加载中...</td></tr>
                            ) : articles.length === 0 ? (
                                <tr><td className="px-4 py-6 text-center text-gray-500" colSpan="7">暂无数据</td></tr>
                            ) : (
                                articles.map(a => (
                                    <tr key={a.id}>
                                        <td className="px-4 py-3 text-sm text-gray-700">{a.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{a.title}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{a.slug}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700 truncate max-w-[20rem]">{a.summary}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{a.authorName}</td>
                                        <td className="px-4 py-3 text-sm">{a.status || 'DRAFT'}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{a.type || '-'}</td>
                                        <td className="px-4 py-3 text-sm text-right space-x-2">
                                            <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" onClick={() => openDetail(a.id)}>详情</button>
                                            <button className="px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={() => openEdit(a)}>编辑</button>
                                            {a.status === 'PUBLISHED' ? (
                                                <button className="px-3 py-1 rounded-md bg-yellow-500 text-white hover:bg-yellow-600" onClick={() => handleUnpublish(a.id)}>下架</button>
                                            ) : (
                                                <button className="px-3 py-1 rounded-md bg-green-600 text-white hover:bg-green-700" onClick={() => handlePublish(a.id)}>发布</button>
                                            )}
                                            <button className="px-3 py-1 rounded-md bg-red-600 text-white hover:bg-red-700" onClick={() => handleDelete(a.id)}>删除</button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>

                <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600">第 {page + 1} / {Math.max(totalPages, 1)} 页</div>
                    <div className="space-x-2">
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page === 0} onClick={handlePrev}>上一页</button>
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page >= totalPages - 1} onClick={handleNext}>下一页</button>
                    </div>
                </div>

                {showAdd && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">新增文章</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="标题" value={addForm.title} onChange={(e) => setAddForm({ ...addForm, title: e.target.value })} />
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="Slug" value={addForm.slug} onChange={(e) => setAddForm({ ...addForm, slug: e.target.value })} />
                                <input className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="摘要" value={addForm.summary} onChange={(e) => setAddForm({ ...addForm, summary: e.target.value })} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="内容" rows="6" value={addForm.content} onChange={(e) => setAddForm({ ...addForm, content: e.target.value })} />
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={addForm.status} onChange={(e) => setAddForm({ ...addForm, status: e.target.value })}>
                                    <option value="DRAFT">草稿</option>
                                    <option value="PUBLISHED">发布</option>
                                </select>
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={addForm.contentFormat || 'PLAINTEXT'} onChange={(e) => setAddForm({ ...addForm, contentFormat: e.target.value })}>
                                    <option value="PLAINTEXT">纯文本</option>
                                    <option value="MARKDOWN">Markdown</option>
                                    <option value="HTML">HTML</option>
                                </select>
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="类型(分类)" value={addForm.type || ''} onChange={(e) => setAddForm({ ...addForm, type: e.target.value })} />
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="作者(可选)" value={addForm.authorName} onChange={(e) => setAddForm({ ...addForm, authorName: e.target.value })} />
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={() => { setShowAdd(false); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={handleAddSave}>保存</button>
                            </div>
                        </div>
                    </div>
                )}

                {showEdit && currentArticle && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">编辑文章</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="text-sm text-gray-500 md:col-span-2">ID: {currentArticle.id}</div>
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="标题" value={currentArticle.title ?? ""} onChange={(e) => setCurrentArticle({ ...currentArticle, title: e.target.value })} />
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="Slug" value={currentArticle.slug ?? ""} onChange={(e) => setCurrentArticle({ ...currentArticle, slug: e.target.value })} />
                                <input className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="摘要" value={currentArticle.summary ?? ""} onChange={(e) => setCurrentArticle({ ...currentArticle, summary: e.target.value })} />
                                <textarea className="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2" placeholder="内容" rows="6" value={currentArticle.content ?? ""} onChange={(e) => setCurrentArticle({ ...currentArticle, content: e.target.value })} />
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={currentArticle.status ?? 'DRAFT'} onChange={(e) => setCurrentArticle({ ...currentArticle, status: e.target.value })}>
                                    <option value="DRAFT">草稿</option>
                                    <option value="PUBLISHED">发布</option>
                                </select>
                                <select className="border border-gray-300 rounded-lg px-3 py-2" value={currentArticle.contentFormat ?? 'PLAINTEXT'} onChange={(e) => setCurrentArticle({ ...currentArticle, contentFormat: e.target.value })}>
                                    <option value="PLAINTEXT">纯文本</option>
                                    <option value="MARKDOWN">Markdown</option>
                                    <option value="HTML">HTML</option>
                                </select>
                                <input className="border border-gray-300 rounded-lg px-3 py-2" placeholder="类型(分类)" value={currentArticle.type ?? ''} onChange={(e) => setCurrentArticle({ ...currentArticle, type: e.target.value })} />
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={() => { setShowEdit(false); setCurrentArticle(null); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={handleEditSave}>保存</button>
                            </div>
                        </div>
                    </div>
                )}

                {showDetail && currentArticle && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">文章详情</h3>
                            <div className="space-y-2">
                                <div className="text-sm text-gray-700">标题: {currentArticle.title}</div>
                                <div className="text-sm text-gray-700">Slug: {currentArticle.slug}</div>
                                <div className="text-sm text-gray-700">作者: {currentArticle.authorName}</div>
                                <div className="text-sm text-gray-700">状态: {currentArticle.status || 'DRAFT'}</div>
                                <div className="text-sm text-gray-700">类型: {currentArticle.type || '-'}</div>
                                <div className="text-sm text-gray-700">格式: {currentArticle.contentFormat || 'PLAINTEXT'}</div>
                                <div className="text-sm text-gray-700">创建时间: {currentArticle.createdAt ? new Date(currentArticle.createdAt).toLocaleString() : '-'}</div>
                                <div className="text-sm text-gray-700">摘要: {currentArticle.summary}</div>
                                <div className="text-sm text-gray-700">内容:</div>
                                <div className="text-sm text-gray-800 whitespace-pre-wrap border border-gray-200 rounded-lg p-3 bg-gray-50">{currentArticle.content}</div>
                            </div>
                            <div className="flex justify-end">
                                <button className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={() => { setShowDetail(false); setCurrentArticle(null); }}>关闭</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    /**
     * 2. 会员管理组件
     */
    const MemberManagementInline = () => {
        const [users, setUsers] = useState([]);
        const [page, setPage] = useState(0);
        const [size, setSize] = useState(10);
        const [totalPages, setTotalPages] = useState(0);
        const [searchTerm, setSearchTerm] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [showAdd, setShowAdd] = useState(false);
        const [showEdit, setShowEdit] = useState(false);
        const [editUser, setEditUser] = useState(null);
        const [addForm, setAddForm] = useState({ username: "", email: "", password: "", nickname: "" });

        const fetchUsers = async (targetPage = page) => {
            setLoading(true);
            setError("");
            try {
                const url = `/api/admin/users?page=${targetPage}&size=${size}${searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : ""}`;
                const response = await fetch(url);
                const text = await response.text();
                const data = JSON.parse(text);
                if (!response.ok) {
                    throw new Error(data.message || "加载用户失败");
                }
                setUsers(data.content || []);
                setTotalPages(data.totalPages || 0);
                setPage(data.number ?? targetPage);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        useEffect(() => {
            fetchUsers(0);
        }, []);

        const handleSearch = () => fetchUsers(0);
        const handlePrev = () => { if (page > 0) fetchUsers(page - 1); };
        const handleNext = () => { if (page < totalPages - 1) fetchUsers(page + 1); };

        const handleAdd = async () => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch('/api/admin/users/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        username: addForm.username,
                        email: addForm.email,
                        password: addForm.password,
                        nickname: addForm.nickname || null
                    })
                });
                const text = await response.text();
                const data = JSON.parse(text || '{}');
                if (!response.ok) {
                    throw new Error(data.message || "新增失败");
                }
                setShowAdd(false);
                setAddForm({ username: "", email: "", password: "", nickname: "" });
                fetchUsers(0);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const openEdit = (user) => { setEditUser({ ...user }); setShowEdit(true); };

        const handleEditSave = async () => {
            if (!editUser) return;
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/admin/users/${editUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        nickname: editUser.nickname,
                        email: editUser.email,
                        vipLevel: editUser.vipLevel,
                        isActive: editUser.isActive
                    })
                });
                const text = await response.text();
                const data = JSON.parse(text || '{}');
                if (!response.ok) {
                    throw new Error(data.message || "更新失败");
                }
                setShowEdit(false);
                setEditUser(null);
                fetchUsers(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const toggleActive = async (user) => {
            setLoading(true);
            setError("");
            try {
                const response = await fetch('/api/admin/users/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ userId: user.id, isActive: !user.isActive })
                });
                const text = await response.text();
                const data = JSON.parse(text || '{}');
                if (!response.ok) {
                    throw new Error(data.message || "状态更新失败");
                }
                fetchUsers(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        const handleDelete = async (id) => {
            if (!confirm('确认删除该用户？')) return;
            setLoading(true);
            setError("");
            try {
                const response = await fetch(`/api/admin/users/${id}`, { method: 'DELETE', credentials: 'same-origin' });
                if (!response.ok && response.status !== 204) {
                    const text = await response.text();
                    try {
                        const data = JSON.parse(text || '{}');
                        throw new Error(data.message || '删除失败');
                    } catch (_) {
                        throw new Error('删除失败');
                    }
                }
                fetchUsers(page);
            } catch (e) {
                setError(e.message || "请求失败");
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="p-6 md:p-10 bg-white rounded-xl shadow-lg w-full h-full space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 flex items-center border-b pb-4 mb-4">
                    <Users className="w-7 h-7 mr-3 text-blue-600" /> 会员用户管理
                </h2>

                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button
                        className="flex items-center bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150"
                        onClick={() => setShowAdd(true)}
                    >
                        <Plus className="w-5 h-5 mr-2" /> 新增会员
                    </button>
                    <div className="relative w-full sm:w-1/3">
                        <input
                            type="search"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            onKeyDown={(e) => { if (e.key === 'Enter') handleSearch(); }}
                            placeholder="按用户名/昵称/邮箱搜索..."
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        />
                        <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    </div>
                    <button
                        className="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md"
                        onClick={handleSearch}
                    >
                        搜索
                    </button>
                </div>

                {error && (
                    <div className="bg-red-100 text-red-700 border border-red-200 p-3 rounded-lg text-sm shadow-md">
                        {error}
                    </div>
                )}

                <div className="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">ID</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">用户名</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">昵称</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">邮箱</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">会员等级</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">状态</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">注册时间</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">操作</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {loading ? (
                                <tr>
                                    <td className="px-4 py-6 text-center text-gray-500" colSpan="8">加载中...</td>
                                </tr>
                            ) : users.length === 0 ? (
                                <tr>
                                    <td className="px-4 py-6 text-center text-gray-500" colSpan="8">暂无数据</td>
                                </tr>
                            ) : (
                                users.map(u => (
                                    <tr key={u.id}>
                                        <td className="px-4 py-3 text-sm text-gray-700">{u.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{u.username}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{u.nickname}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{u.email}</td>
                                        <td className="px-4 py-3 text-sm text-gray-700">VIP{u.vipLevel}</td>
                                        <td className="px-4 py-3 text-sm">
                                            <span className={u.isActive ? "text-green-600" : "text-red-600"}>{u.isActive ? "激活" : "禁用"}</span>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-gray-700">{new Date(u.registrationDate).toLocaleString()}</td>
                                        <td className="px-4 py-3 text-sm text-right space-x-2">
                                            <button className="px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={() => openEdit(u)}>编辑</button>
                                            <button className="px-3 py-1 rounded-md bg-yellow-500 text-white hover:bg-yellow-600" onClick={() => toggleActive(u)}>{u.isActive ? "禁用" : "启用"}</button>
                                            <button className="px-3 py-1 rounded-md bg-red-600 text-white hover:bg-red-700" onClick={() => handleDelete(u.id)}>删除</button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>

                <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600">第 {page + 1} / {Math.max(totalPages, 1)} 页</div>
                    <div className="space-x-2">
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page === 0} onClick={handlePrev}>上一页</button>
                        <button className="px-3 py-1 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50" disabled={page >= totalPages - 1} onClick={handleNext}>下一页</button>
                    </div>
                </div>

                {showAdd && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">新增会员</h3>
                            <div className="space-y-3">
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="用户名" value={addForm.username} onChange={(e) => setAddForm({ ...addForm, username: e.target.value })} />
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="邮箱" value={addForm.email} onChange={(e) => setAddForm({ ...addForm, email: e.target.value })} />
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="密码" type="password" value={addForm.password} onChange={(e) => setAddForm({ ...addForm, password: e.target.value })} />
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="昵称(可选)" value={addForm.nickname} onChange={(e) => setAddForm({ ...addForm, nickname: e.target.value })} />
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={() => { setShowAdd(false); setAddForm({ username: "", email: "", password: "", nickname: "" }); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={handleAdd}>保存</button>
                            </div>
                        </div>
                    </div>
                )}

                {showEdit && editUser && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">编辑会员</h3>
                            <div className="space-y-3">
                                <div className="text-sm text-gray-500">ID: {editUser.id} 用户名: {editUser.username}</div>
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="昵称" value={editUser.nickname ?? ""} onChange={(e) => setEditUser({ ...editUser, nickname: e.target.value })} />
                                <input className="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="邮箱" value={editUser.email ?? ""} onChange={(e) => setEditUser({ ...editUser, email: e.target.value })} />
                                <select className="w-full border border-gray-300 rounded-lg px-3 py-2" value={editUser.vipLevel ?? 0} onChange={(e) => setEditUser({ ...editUser, vipLevel: parseInt(e.target.value, 10) })}>
                                    <option value={0}>VIP0</option>
                                    <option value={1}>VIP1</option>
                                    <option value={2}>VIP2</option>
                                    <option value={3}>VIP3</option>
                                    <option value={4}>VIP4</option>
                                    <option value={5}>VIP5</option>
                                </select>
                                <label className="inline-flex items-center space-x-2">
                                    <input type="checkbox" checked={!!editUser.isActive} onChange={(e) => setEditUser({ ...editUser, isActive: e.target.checked })} />
                                    <span className="text-sm text-gray-700">激活</span>
                                </label>
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button className="px-4 py-2 rounded-md bg-gray-200 text-gray-700" onClick={() => { setShowEdit(false); setEditUser(null); }}>取消</button>
                                <button className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onClick={handleEditSave}>保存</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    /**
     * 3. 仪表盘概览组件
     */
    // DashboardSummary 组件已迁移到独立文件 /js/dashboard-summary.js


    /**
     * 4. 后台管理容器组件 (Dashboard)
     */
    const Dashboard = ({ userId, adminView, setAdminView }) => {
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
        const [summaryReady, setSummaryReady] = useState(!!(window.Components && window.Components.DashboardSummary));
        const [membersReady, setMembersReady] = useState(!!(window.Components && window.Components.MemberManagement));
        const [articlesReady, setArticlesReady] = useState(!!(window.Components && window.Components.ArticleManagement));
        const [commentsReady, setCommentsReady] = useState(!!(window.Components && window.Components.CommentManagement));
        const [likesReady, setLikesReady] = useState(!!(window.Components && window.Components.LikeManagement));
        const [categoriesReady, setCategoriesReady] = useState(!!(window.Components && window.Components.CategoryManagement));
        const [interviewReady, setInterviewReady] = useState(!!(window.Components && window.Components.InterviewManagement));
        const [aiToolsReady, setAiToolsReady] = useState(!!(window.Components && window.Components.AIToolManagement));
        const [examReady, setExamReady] = useState(!!(window.Components && window.Components.ExamAdmin));
        const [examSessionsReady, setExamSessionsReady] = useState(!!(window.Components && window.Components.ExamSessionAdmin));
        const [examMenuOpen, setExamMenuOpen] = useState(false);

        const loadScriptOnce = (src) => new Promise((resolve, reject) => {
            if ([...document.scripts].some(s => s.src.endsWith(src))) { resolve(); return; }
            const tag = document.createElement('script');
            tag.src = src; tag.defer = true;
            tag.onload = () => resolve();
            tag.onerror = (e) => reject(e);
            document.head.appendChild(tag);
        });

        useEffect(() => {
            const handler = () => {
                if (window.Components && window.Components.DashboardSummary) setSummaryReady(true);
                if (window.Components && window.Components.MemberManagement) setMembersReady(true);
                if (window.Components && window.Components.ArticleManagement) setArticlesReady(true);
                if (window.Components && window.Components.CommentManagement) setCommentsReady(true);
                if (window.Components && window.Components.LikeManagement) setLikesReady(true);
                if (window.Components && window.Components.CategoryManagement) setCategoriesReady(true);
                if (window.Components && window.Components.InterviewManagement) setInterviewReady(true);
                if (window.Components && window.Components.AIToolManagement) setAiToolsReady(true);
                if (window.Components && window.Components.ExamAdmin) setExamReady(true);
                if (window.Components && window.Components.ExamSessionAdmin) setExamSessionsReady(true);
            };
            window.addEventListener('modules:loaded', handler);
            return () => window.removeEventListener('modules:loaded', handler);
        }, []);

        useEffect(() => {
            if (adminView === 'summary' && !(window.Components && window.Components.DashboardSummary)) {
                loadScriptOnce('/js/dashboard-summary.js').then(() => setSummaryReady(!!(window.Components && window.Components.DashboardSummary))).catch(() => {});
            }
            if (adminView === 'members' && !(window.Components && window.Components.MemberManagement)) {
                loadScriptOnce('/js/member-management.js').then(() => setMembersReady(!!(window.Components && window.Components.MemberManagement))).catch(() => {});
            }
            if (adminView === 'articles' && !(window.Components && window.Components.ArticleManagement)) {
                loadScriptOnce('/js/article-management.js').then(() => setArticlesReady(!!(window.Components && window.Components.ArticleManagement))).catch(() => {});
            }
            if (adminView === 'comments' && !(window.Components && window.Components.CommentManagement)) {
                loadScriptOnce('/js/comment-management.js').then(() => setCommentsReady(!!(window.Components && window.Components.CommentManagement))).catch(() => {});
            }
            if (adminView === 'likes' && !(window.Components && window.Components.LikeManagement)) {
                loadScriptOnce('/js/like-management.js').then(() => setLikesReady(!!(window.Components && window.Components.LikeManagement))).catch(() => {});
            }
            if (adminView === 'categories' && !(window.Components && window.Components.CategoryManagement)) {
                loadScriptOnce('/js/category-management.js').then(() => setCategoriesReady(!!(window.Components && window.Components.CategoryManagement))).catch(() => {});
            }
            if (adminView === 'recharge' && !(window.Components && window.Components.RechargeManagement)) {
                loadScriptOnce('/js/recharge-management.js').catch(() => {});
            }
            if (adminView === 'system' && !(window.Components && window.Components.SystemManagement)) {
                loadScriptOnce('/js/system-management.js').catch(() => {});
            }
            if (adminView === 'interview') {
                // 立即同步一次就绪状态，避免事件触发顺序导致不刷新
                setInterviewReady(!!(window.Components && window.Components.InterviewManagement));
                if (!(window.Components && window.Components.InterviewManagement)) {
                    loadScriptOnce('/js/interview-management.js')
                      .then(() => setInterviewReady(!!(window.Components && window.Components.InterviewManagement)))
                      .catch(() => {});
                }
            }
            if (adminView === 'ai-tools' && !(window.Components && window.Components.AIToolManagement)) {
                loadScriptOnce('/js/ai-tool-management.js')
                  .then(() => setAiToolsReady(!!(window.Components && window.Components.AIToolManagement)))
                  .catch(() => {});
            }
            if (adminView === 'exam' && !(window.Components && window.Components.ExamAdmin)) {
                loadScriptOnce('/js/exam-admin.js')
                  .then(() => setExamReady(!!(window.Components && window.Components.ExamAdmin)))
                  .catch(() => {});
            }
            if (adminView === 'exam-questions' && !(window.Components && window.Components.ExamAdmin)) {
                loadScriptOnce('/js/exam-admin.js')
                  .then(() => setExamReady(!!(window.Components && window.Components.ExamAdmin)))
                  .catch(() => {});
            }
            if (adminView === 'exam-sessions' && !(window.Components && window.Components.ExamSessionAdmin)) {
                loadScriptOnce('/js/exam-session-admin.js')
                  .then(() => setExamSessionsReady(!!(window.Components && window.Components.ExamSessionAdmin)))
                  .catch(() => {});
            }
        }, [adminView]);

        const navItems = [
            { id: 'summary', name: '仪表盘概览', icon: LayoutDashboard },
            { id: 'members', name: '会员管理', icon: Users },
            { id: 'articles', name: '文章管理', icon: FileText },
            { id: 'comments', name: '评论管理', icon: MessageSquare },
            { id: 'likes', name: '点赞管理', icon: Heart },
            { id: 'recharge',  name: '充值管理', icon: Gift },
            { id: 'categories', name: '分类管理', icon: Layers },
            { id: 'exam', name: '考试管理', icon: BookOpen },
            { id: 'interview', name: '面试宝典', icon: BookOpen },
            { id: 'ai-tools', name: 'AI功能管理', icon: Cpu },
            { id: 'system', name: '系统管理', icon: Settings },
        ];

        const renderAdminContent = () => {
            const SummaryComp = window.Components && window.Components.DashboardSummary;
            const ArticleManagementComp = window.Components && window.Components.ArticleManagement;
            const MemberManagementComp = window.Components && window.Components.MemberManagement;
            const CommentManagementComp = window.Components && window.Components.CommentManagement;
            const LikeManagementComp = window.Components && window.Components.LikeManagement;
            const CategoryManagementComp = window.Components && window.Components.CategoryManagement;
            const RechargeManagementComp = window.Components && window.Components.RechargeManagement;
            const InterviewManagementComp = window.Components && window.Components.InterviewManagement;
            const AIToolManagementComp = window.Components && window.Components.AIToolManagement;
            const ExamAdminComp = window.Components && window.Components.ExamAdmin;
            const SystemManagementComp = window.Components && window.Components.SystemManagement;
            const needSummary = adminView === 'summary' && !summaryReady;
            const needMembers = adminView === 'members' && !membersReady;
            const needArticles = adminView === 'articles' && !articlesReady;
            const needComments = adminView === 'comments' && !commentsReady;
            const needLikes = adminView === 'likes' && !likesReady;
            const needCategories = adminView === 'categories' && !categoriesReady;
            const needRecharge = adminView === 'recharge' && !(window.Components && window.Components.RechargeManagement);
            const needInterview = adminView === 'interview' && !(window.Components && window.Components.InterviewManagement);
            const needAITools = adminView === 'ai-tools' && !aiToolsReady;
            const needExam = adminView === 'exam' && !examReady;
            const needExamQuestions = adminView === 'exam-questions' && !examReady;
            const needExamSessions = adminView === 'exam-sessions' && !(window.Components && window.Components.ExamSessionAdmin);
            if (needSummary || needMembers || needArticles || needComments || needLikes || needCategories || needRecharge || needInterview || needAITools || needExam || needExamQuestions || needExamSessions) {
                return (
                    <div className="p-6 flex items-center space-x-3 text-gray-600">
                        <svg className="animate-spin h-5 w-5 text-blue-600" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>组件加载中...</span>
                    </div>
                );
            }
            switch (adminView) {
                case 'summary':
                    return (typeof SummaryComp === 'function') ? <SummaryComp userId={userId} /> : <div className="p-6">组件加载中...</div>;
                case 'members':
                    return (typeof MemberManagementComp === 'function') ? <MemberManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'articles':
                    return (typeof ArticleManagementComp === 'function') ? <ArticleManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'comments':
                    return (typeof CommentManagementComp === 'function') ? <CommentManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'likes':
                    return (typeof LikeManagementComp === 'function') ? <LikeManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'categories':
                    return (typeof CategoryManagementComp === 'function') ? <CategoryManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'recharge':
                    return (typeof RechargeManagementComp === 'function') ? <RechargeManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'interview':
                    return (typeof InterviewManagementComp === 'function') ? <InterviewManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'ai-tools':
                    return (typeof AIToolManagementComp === 'function') ? <AIToolManagementComp /> : <div className="p-6">组件加载中...</div>;
                case 'exam':
                    return (typeof ExamAdminComp === 'function') ? <ExamAdminComp /> : <div className="p-6">组件加载中...</div>;
                case 'exam-questions':
                    return (typeof ExamAdminComp === 'function') ? <ExamAdminComp /> : <div className="p-6">组件加载中...</div>;
                case 'exam-sessions':
                    const ExamSessionAdminComp = window.Components && window.Components.ExamSessionAdmin;
                    return (typeof ExamSessionAdminComp === 'function') ? <ExamSessionAdminComp /> : <div className="p-6">组件加载中...</div>;
                case 'system':
                    return (typeof SystemManagementComp === 'function') ? <SystemManagementComp /> : <div className="p-6">组件加载中...</div>;
                default:
                    return <DashboardSummary userId={userId} />;
            }
        };

        const currentLabel = (adminView==='exam-questions' ? '题库' : adminView==='exam-sessions' ? '考试' : (navItems.find(n => n.id === adminView)?.name) || '仪表盘概览');

        const AdminTopBar = () => (
            <div className="sticky top-16 z-10 bg-white/80 backdrop-blur rounded-2xl border border-gray-200 px-6 py-4 mb-4 shadow-sm flex items-center justify-between">
                <div className="flex items-center gap-2">
                    <span className="text-gray-500 text-base">管理导航</span>
                    <span className="text-gray-400">›</span>
                    <span className="text-xl font-bold text-gray-900">{currentLabel}</span>
                </div>
            </div>
        );

        // 侧边栏按钮样式
        const getButtonClasses = (id) => {
            const base = "w-full flex items-center justify-between px-5 py-4 rounded-2xl font-bold text-lg transition duration-150";
            return id === adminView
                ? `${base} bg-blue-600 text-white shadow-lg shadow-blue-500/30`
                : `${base} text-gray-700 hover:bg-gray-100`;
        };

        const getIconClasses = (id) => id === adminView ? `${sidebarCollapsed ? 'mx-auto' : 'mr-3'} w-6 h-6 text-white` : `${sidebarCollapsed ? 'mx-auto' : 'mr-3'} w-6 h-6 text-gray-700`;

        return (
            <div className="w-full min-h-[calc(100vh-8rem)] flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 p-6">
                {/* 移动端菜单按钮 */}
                <div className="md:hidden">
                    <button
                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                        className="w-full flex items-center justify-center p-3 rounded-lg bg-blue-600 text-white shadow-md hover:bg-blue-700"
                    >
                        {isSidebarOpen ? <X className="w-5 h-5 mr-2" /> : <Menu className="w-5 h-5 mr-2" />}
                        {isSidebarOpen ? '关闭菜单' : '管理菜单'}
                    </button>
                </div>

                {/* 侧边栏 */}
                <aside className={`${isSidebarOpen ? 'block' : 'hidden md:block'} bg白 p-4 rounded-2xl shadow-xl border border-gray-100 md:flex-shrink-0 ${sidebarCollapsed ? 'md:w-24' : 'md:w-80'} w-full`} style={{ height: isSidebarOpen ? 'auto' : 'fit-content' }}>
                    <nav className="space-y-2">
                        <div className="flex items-center justify-between px-3 pt-2 pb-3 border-b">
                            {!sidebarCollapsed && <h3 className="text-lg font-semibold text-gray-900">管理导航</h3>}
                            <button className="px-2 py-1 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700" onClick={()=>setSidebarCollapsed(!sidebarCollapsed)}>
                                {sidebarCollapsed ? '展开' : '折叠'}
                            </button>
                        </div>
                        {navItems.map(item => (
                            item.id === 'exam' ? (
                              <React.Fragment key={item.id}>
                                <button
                                  onClick={() => { setExamMenuOpen(o=>!o); setIsSidebarOpen(false); }}
                                  className={getButtonClasses(item.id)}
                                >
                                  <span className="flex items-center">
                                    <item.icon className={getIconClasses(item.id)} />
                                    {!sidebarCollapsed && <span className="ml-3">{item.name}</span>}
                                  </span>
                                  {!sidebarCollapsed && (<ChevronRight className={`w-5 h-5 ${examMenuOpen ? 'text-white rotate-90' : (item.id===adminView?'text-white':'text-gray-700')}`} />)}
                                </button>
                                {examMenuOpen && (
                                  <div className="space-y-2 ml-6">
                                    <button
                                      onClick={() => { setAdminView('exam-questions'); setIsSidebarOpen(false); }}
                                      className={getButtonClasses('exam-questions')}
                                    >
                                      <span className="flex items-center">
                                        <FileText className={getIconClasses('exam-questions')} />
                                        {!sidebarCollapsed && <span className="ml-3">题库</span>}
                                      </span>
                                      {!sidebarCollapsed && (adminView==='exam-questions' ? <ChevronRight className="w-5 h-5 text-white" /> : <span className="w-5 h-5" />)}
                                    </button>
                                    <button
                                      onClick={() => { setAdminView('exam-sessions'); setIsSidebarOpen(false); }}
                                      className={getButtonClasses('exam-sessions')}
                                    >
                                      <span className="flex items-center">
                                        <BookOpen className={getIconClasses('exam-sessions')} />
                                        {!sidebarCollapsed && <span className="ml-3">考试</span>}
                                      </span>
                                      {!sidebarCollapsed && (adminView==='exam-sessions' ? <ChevronRight className="w-5 h-5 text-white" /> : <span className="w-5 h-5" />)}
                                    </button>
                                  </div>
                                )}
                              </React.Fragment>
                            ) : (
                              <button
                                key={item.id}
                                onClick={() => {
                                    setAdminView(item.id);
                                    setIsSidebarOpen(false);
                                }}
                                className={getButtonClasses(item.id)}
                              >
                                <span className="flex items-center">
                                    <item.icon className={getIconClasses(item.id)} />
                                    {!sidebarCollapsed && <span className="ml-3">{item.name}</span>}
                                </span>
                                {!sidebarCollapsed && (item.id === adminView ? <ChevronRight className="w-5 h-5 text-white" /> : <span className="w-5 h-5" />)}
                              </button>
                            )
                        ))}
                    </nav>
                </aside>

                {/* 内容区域 */}
                <section className="flex-grow px-2 md:px-4">
                    <AdminTopBar />
                    <ErrorBoundary>
                        {renderAdminContent()}
                    </ErrorBoundary>
                </section>
            </div>
        );
    };


    /**
     * 主应用组件
     */
    function App() {
        // 视图状态：'auth', 'home', 'dashboard', 'articles', 'tools', 'vip'
        const [view, setView] = useState('loading');
        const [isLoggedIn, setIsLoggedIn] = useState(false);
        const [userId, setUserId] = useState(null);
        // 新增：用于管理 Dashboard 内部的子视图
        const [adminView, setAdminView] = useState('summary');

        // 检查初始认证状态（模拟）
        useEffect(() => {
            const token = sessionStorage.getItem('authToken');
            if (token) {
                setIsLoggedIn(true);
                setUserId(token.split('-').pop());
                setView('dashboard');
            } else {
                setView('auth');
            }
        }, []);

        const handleLogout = () => {
            sessionStorage.removeItem('authToken');
            setIsLoggedIn(false);
            setUserId(null);
            setView('auth');
            setAdminView('summary'); // 重置管理视图状态
        };

        const renderContent = () => {
            if (view === 'loading') {
                return (
                    <div className="flex items-center justify-center h-64">
                        <svg className="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p className="text-lg text-gray-600">正在检查登录状态...</p>
                    </div>
                );
            }

            // 未登录时，只允许访问认证页面和主页
            if (!isLoggedIn && view !== 'auth' && view !== 'home') {
                return <AuthForm setView={setView} setIsLoggedIn={setIsLoggedIn} setUserId={setUserId} />;
            }

            const UserHomeComp = window.Components && window.Components.UserHome;

            switch (view) {
                case 'auth':
                    // 如果已登录，跳转到 Dashboard，防止重复登录
                    if(isLoggedIn) return <Dashboard userId={userId} adminView={adminView} setAdminView={setAdminView} />;
                    return <AuthForm setView={setView} setIsLoggedIn={setIsLoggedIn} setUserId={setUserId} />;
                case 'home':
                    window.location.href = '/home.html';
                    return <div className="p-6">正在跳转用户主页...</div>;
                case 'dashboard':
                    // 渲染管理后台容器，并传递子视图状态和修改函数
                    return <Dashboard userId={userId} adminView={adminView} setAdminView={setAdminView} />;
                case 'articles':
                    return <PlaceholderPage title="技术文章中心" description="这里将展示您的博客和技术内容列表，支持搜索和分类。" />;
                case 'tools':
                    return <PlaceholderPage title="AI 工具箱" description="未来将集成各种 AI 模型和实用工具，供用户调用。" />;
                case 'vip':
                    return <PlaceholderPage title="VIP 尊享服务" description="此处用于展示会员专属权益和升级服务，包括高级AI模型访问权限。" />;
                default:
                    return <PlaceholderPage title="页面未找到" description="您访问的页面不存在。" />;
            }
        };

        return (
            <div
                className="min-h-screen bg-gray-50 flex flex-col font-sans"
            >
                <Header setView={setView} isLoggedIn={isLoggedIn} userId={userId} handleLogout={handleLogout} />
                {}
                <main className={`flex-grow flex ${view === 'dashboard' ? 'justify-start' : 'justify-center'} items-start md:items-center p-0 md:p-4`}>
                    {renderContent()}
                </main>
                <footer className="w-full text-center p-4 text-sm text-gray-500 border-t mt-auto">
                    © {new Date().getFullYear()} TonyWu AI 平台. All rights reserved.
                </footer>
            </div>
        );
    }

    // 渲染组件到 DOM
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
                <div className="grid grid-cols-3 gap-3">
                    
                </div>
